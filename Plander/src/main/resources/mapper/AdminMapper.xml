<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="com.bit.mapper.AdminMapper">

	<!-- 회원List -->
	<select id="getUserList" resultType="com.bit.domain.UsersVO"
		parameterType="com.bit.utils.PagingVO">
		<![CDATA[
		select *    
    		from (select rownum rn, u_idx, id, name, phone, email, rank, regdate, zipno, roadAddrPart1, addrDetail from users)
    		where rn between #{start} and #{end}
    		order by u_idx
    	]]>
	</select>

	<select id="getSearchList" resultType="com.bit.domain.UsersVO"
		parameterType="map">
		select *
		from (
		select rownum rn, u_idx, id, name, phone, email, rank, regdate, zipno,
		roadAddrPart1, addrDetail
		from users
		where
		<choose>
			<when test="target == 'id'.toString()">
				id like '%' || #{keyword} || '%'
			</when>

			<when test="target == 'name'.toString()">
				name like '%' || #{keyword} || '%'
			</when>
		</choose>
		)
		where rn between #{start} and #{end}
	</select>

	<select id="getSearchTotal" resultType="int" parameterType="map">
		select count(*) from users where
		<choose>
			<when test="target == 'id'.toString()">
				id like '%' || #{keyword} || '%'
			</when>

			<when test="target == 'name'.toString()">
				name like '%' || #{keyword} || '%'
			</when>
		</choose>
	</select>
	
	<!-- 전체 회원 수 -->
	<select id="getTotal" resultType="int">
		SELECT count(*) FROM USERS
	</select>

	<!-- 예약된 사물함 -->
	<select id="bookingCabinet"
		resultType="com.bit.domain.BookingCbVO">
		select *
		from booking_cb bc, cabinet c
		where c.cb_idx =
		bc.cb_idx
		and sysdate between bc.start_date and end_date
		and br_idx=
		#{br_idx}
	</select>

	<!-- 예약된 사물함 수 -->
	<select id="bookingCabinet_count" resultType="int">
		select
		count(bc.ckb_idx)
		from booking_cb bc, cabinet c
		where c.cb_idx =
		bc.cb_idx
		and sysdate between bc.start_date and end_date
		and br_idx=
		#{br_idx}
	</select>
	
	<!-- 회원삭제 -->
	<delete id="userDelete" parameterType="int">
		delete from users
			where u_idx = #{u_idx}
	</delete>
	
	<!-- 좌석별 현황  -->
	<select id="BookingSeats" resultType="com.bit.domain.BookingVO">
		select distinct b.id, b.start_time, b.end_time, s.s_col
	    from seats s, booking b
	    where s.s_idx = b.s_idx
	    and br_idx = #{br_idx}
	    <!-- and s_col = #{s_col} -->
	    and (
	        (to_char(start_time, 'YYYYMM') = to_char(sysdate, 'YYYYMM') and to_char(end_time, 'YYYYMM') = to_char(sysdate, 'YYYYMM'))
	        or 
	        (to_char(start_time, 'YYYYMM') = to_char(sysdate, 'YYYYMM') and to_char(end_time, 'YYYYMM') = to_char(add_months(sysdate, 1), 'YYYYMM'))
	        or 
	        (to_char(start_time, 'YYYYMM') = to_char(add_months(sysdate, -1), 'YYYYMM') and to_char(end_time, 'YYYYMM') = to_char(sysdate, 'YYYYMM'))
	        )
	</select>
	
	<!-- 좌석이동 -->
	<update id="changeSeats" parameterType="Map">
		update (
		     select b.s_idx as s_idx
		     from booking b, seats s
		     where b.s_idx = s.s_idx
		     and b.id = #{id}
		     and s.br_idx = #{br_idx}
		     and b.start_time = to_date(#{start_time}, 'YYYY-MM-DD HH24:MI:SS')
		     and b.end_time = to_date(#{end_time}, 'YYYY-MM-DD HH24:MI:SS')
		)
		set s_idx = #{s_idx}
	</update>
</mapper>



